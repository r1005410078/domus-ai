# 智能检索技术方案（Semantic Search System）

## 1. 概述（Overview）

说明该模块的目标、业务背景、解决什么问题、提供什么能力。

## 2. 功能目标（Objectives）

- 实现自然语言驱动的房源检索
- 支持语义理解能力
- 支持结构化筛选
- 支持重排序，提高准确性
- 支持高性能查询

## 3. 系统架构（Architecture）

（可放结构图 / 文本图）

用户输入 → 预处理 → 向量化 → 向量检索 → 条件过滤 → LLM 重排序 → 返回结果

## 4. 技术选型（Tech Choices）

- Python + LangChain
- Embedding 模型：bge-m3
- 向量库：FAISS / Chroma
- 服务：FastAPI
- 数据：JSON / CSV / PostgreSQL（可选）

## 5. 数据流设计（Data Flow）

1. 导入房源数据（API、DB、文件等） ✅
2. 预处理（清洗、结构化） ✅
3. 生成 embeddings ✅
4. 写入[向量库](https://github.com/qdrant/qdrant)

```plaintext
  ┌───────────────────┐
    │ 房源系统 API / DB  │
    └─────────┬─────────┘
              │
              ▼
    ┌───────────────────┐
    │ 数据预处理         │
    │ 清洗、结构化、去重 │
    └─────────┬─────────┘
              │
              ▼
    ┌───────────────────┐
    │ 生成 Embeddings    │
    │ OpenAI / 自训练模型│
    └─────────┬─────────┘
              │
              ▼
    ┌───────────────────┐
    │ 写入向量库         │
    │ Chroma / FAISS     │
    └─────────┬─────────┘
              │
              ▼
    ┌───────────────────┐
    │ 用户搜索查询       │
    │ 生成 Query Embedding│
    └─────────┬─────────┘
              │
              ▼
    ┌───────────────────┐
    │ 向量库检索         │
    │ 相似度计算 & top-k │
    └─────────┬─────────┘
              │
              ▼
    ┌───────────────────┐
    │ 返回匹配房源       │
    │ metadata + 向量分数│
    └───────────────────┘
```

4. 用户输入处理
5. 语义检索（kNN）
6. 规则过滤
7. LLM 重排序
8. 返回结果

```plaintext
┌─────────────────────────────┐
│       用户输入查询           │
│ "回祥小区 3室以上的房子"     │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│    用户输入处理 (Preprocess) │
│ - 文本清洗                   │
│ - 提取: district="回祥小区"  │
│ - 提取: min_rooms=3         │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│   查询向量生成              │
│ 1. 构造查询文本:            │
│    "回祥小区 3室 住宅"      │
│ 2. 调用embedding模型        │
│ 3. 生成query_vector         │
└─────────────┬───────────────┘
              │
              ▼
           query_vector
              │
              ▼
┌─────────────────────────────┐
│        规则过滤 (Filter)     │
│ - 根据结构化字段精确过滤     │
│   例：rooms >= 3            │
│ - 可过滤面积、价格、楼层等   │
│ - 可以组合多个条件           │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│   向量数据库检索 (kNN)       │
│ 使用query_vector在过滤后的   │
│ 房源中进行语义检索          │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│      LLM 重排序 (Rerank)     │
│ - 使用大模型理解查询意图      │
│ - 对候选房源进行语义匹配评分 │
│ - 可参考用户意图、标签、备注  │
│ - 输出最终排序列表             │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│        返回最终房源列表       │
│ - 包含房源信息、图片、价格等 │
│ - 可用于前端展示或二次处理   │
└─────────────────────────────┘
```

## 6. Pipeline 设计（Chain Design）

描述各节点职责：

- PreprocessNode
- EmbeddingNode
- VectorstoreNode
- FilterNode
- RankNode

以及 search_chain 如何组织这些节点。

## 7. 接口设计（API Design）

### POST /search

请求字段、响应字段等。

## 8. 性能与优化（Performance）

- 向量库缓存
- 搜索分页
- 过滤前移
- 结果 TOP-K 限制
- 模型缓存机制

## 9. 错误处理（Error Handling）

- 模型请求失败
- 向量库异常
- 输入异常
- 数据缺失

## 10. 安全（Security）

- API Key 管理
- 限流
- 服务隔离
- 数据保护

## 11. 可扩展性（Scalability）

- 多模型支持
- 微服务拆分
- 插件化 Pipeline

## 12. 后续规划（Future Work）

- 支持 Agent
- 支持问答机器人
- 支持用户画像推荐
